<h2>Notification Details</h2>

<div class="notification-detail">
  <div class="detail-header">
    <div class="detail-title">
      <span class="badge badge-<%= @notification.direction %>">
        <%= @notification.direction == 'sent' ? 'üì§ SENT' : 'üì• RECEIVED' %>
      </span>
      <span class="status-badge status-<%= @notification.status %>">
        <%= @notification.status.upcase %>
      </span>
    </div>
    <div class="detail-actions">
      <% if @notification.status == 'failed' && @notification.direction == 'received' %>
        <form method="POST" action="/coar/dashboard/notifications/<%= @notification.id %>/retry" style="display: inline;">
          <button type="submit" class="btn btn-warning btn-small">
            üîÑ Retry
          </button>
        </form>
      <% end %>
      <a href="/coar/dashboard" class="btn btn-secondary btn-small">
        ‚Üê Back to List
      </a>
    </div>
  </div>

  <div class="detail-grid">
    <!-- Basic Information -->
    <div class="detail-section">
      <h3>Basic Information</h3>
      <table class="detail-table">
        <tr>
          <th>Database ID:</th>
          <td><code><%= @notification.id %></code></td>
        </tr>
        <tr>
          <th>Notification ID:</th>
          <td><code class="notification-id-full"><%= @notification.notification_id %></code></td>
        </tr>
        <tr>
          <th>Direction:</th>
          <td><%= @notification.direction.capitalize %></td>
        </tr>
        <tr>
          <th>Status:</th>
          <td>
            <span class="status-badge status-<%= @notification.status %>">
              <%= @notification.status %>
            </span>
          </td>
        </tr>
        <tr>
          <th>Types:</th>
          <td><%= @notification.notification_types.join(', ') %></td>
        </tr>
        <tr>
          <th>Primary Type:</th>
          <td><strong><%= @notification.primary_type %></strong></td>
        </tr>
      </table>
    </div>

    <!-- Service & Paper Information -->
    <div class="detail-section">
      <h3>Service & Paper</h3>
      <table class="detail-table">
        <tr>
          <th>Service Name:</th>
          <td><%= @notification.service_name || '-' %></td>
        </tr>
        <tr>
          <th>Origin ID:</th>
          <td><code><%= @notification.origin_id %></code></td>
        </tr>
        <tr>
          <th>Target ID:</th>
          <td><code><%= @notification.target_id %></code></td>
        </tr>
        <tr>
          <th>Paper DOI:</th>
          <td>
            <% if @notification.paper_doi %>
              <a href="https://doi.org/<%= @notification.paper_doi %>" target="_blank">
                <%= @notification.paper_doi %>
              </a>
            <% else %>
              -
            <% end %>
          </td>
        </tr>
        <tr>
          <th>GitHub Issue:</th>
          <td>
            <% if @notification.issue_id %>
              <a href="https://github.com/<%= ENV['REVIEWS_REPOSITORY'] || 'neurolibre/neurolibre-reviews' %>/issues/<%= @notification.issue_id %>" target="_blank">
                #<%= @notification.issue_id %>
              </a>
            <% else %>
              -
            <% end %>
          </td>
        </tr>
      </table>
    </div>

    <!-- Notification Content -->
    <div class="detail-section">
      <h3>Content</h3>
      <table class="detail-table">
        <tr>
          <th>Object ID:</th>
          <td><code><%= @notification.object_id %></code></td>
        </tr>
        <tr>
          <th>Object Type:</th>
          <td><%= @notification.object_type || '-' %></td>
        </tr>
        <tr>
          <th>Context ID:</th>
          <td>
            <% if @notification.context_id %>
              <code><%= @notification.context_id %></code>
            <% else %>
              -
            <% end %>
          </td>
        </tr>
        <tr>
          <th>In Reply To:</th>
          <td>
            <% if @notification.in_reply_to %>
              <code><%= @notification.in_reply_to %></code>
            <% else %>
              -
            <% end %>
          </td>
        </tr>
        <tr>
          <th>Actor:</th>
          <td>
            <% if @notification.actor_id %>
              <%= @notification.actor_name || @notification.actor_id %>
            <% else %>
              -
            <% end %>
          </td>
        </tr>
        <tr>
          <th>Summary:</th>
          <td><%= @notification.summary || '-' %></td>
        </tr>
      </table>
    </div>

    <!-- Timestamps & Processing -->
    <div class="detail-section">
      <h3>Timestamps</h3>
      <table class="detail-table">
        <tr>
          <th>Created:</th>
          <td><%= @notification.created_at.strftime('%Y-%m-%d %H:%M:%S %Z') %></td>
        </tr>
        <tr>
          <th>Updated:</th>
          <td><%= @notification.updated_at.strftime('%Y-%m-%d %H:%M:%S %Z') %></td>
        </tr>
        <tr>
          <th>Processed:</th>
          <td>
            <% if @notification.processed_at %>
              <%= @notification.processed_at.strftime('%Y-%m-%d %H:%M:%S %Z') %>
            <% else %>
              -
            <% end %>
          </td>
        </tr>
      </table>

      <% if @notification.error_message %>
        <h3 class="error-heading">Error Message</h3>
        <div class="error-message">
          <pre><%= @notification.error_message %></pre>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Full Payload -->
  <div class="detail-section full-width">
    <h3>Full JSON-LD Payload</h3>
    <details>
      <summary class="payload-toggle">Click to show/hide payload</summary>
      <div class="payload-container">
        <button onclick="copyPayload()" class="btn btn-small btn-secondary copy-btn">
          üìã Copy to Clipboard
        </button>
        <pre id="payload-json" class="payload-json"><%= @payload_json %></pre>
      </div>
    </details>
  </div>
</div>

<script>
function copyPayload() {
  const payload = document.getElementById('payload-json').textContent;
  navigator.clipboard.writeText(payload).then(() => {
    alert('Payload copied to clipboard!');
  }).catch(err => {
    console.error('Failed to copy:', err);
    alert('Failed to copy payload');
  });
}
</script>
