<h2>Notification History</h2>

<div class="filters-section">
  <form method="GET" action="/coar/dashboard" class="filters-form">
    <div class="filter-group">
      <label for="direction">Direction:</label>
      <select name="direction" id="direction" onchange="this.form.submit()">
        <option value="" <%= 'selected' if @direction.nil? %>>All</option>
        <option value="sent" <%= 'selected' if @direction == 'sent' %>>Sent</option>
        <option value="received" <%= 'selected' if @direction == 'received' %>>Received</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="status">Status:</label>
      <select name="status" id="status" onchange="this.form.submit()">
        <option value="" <%= 'selected' if @status.nil? %>>All</option>
        <option value="pending" <%= 'selected' if @status == 'pending' %>>Pending</option>
        <option value="processing" <%= 'selected' if @status == 'processing' %>>Processing</option>
        <option value="processed" <%= 'selected' if @status == 'processed' %>>Processed</option>
        <option value="failed" <%= 'selected' if @status == 'failed' %>>Failed</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="service">Service:</label>
      <select name="service" id="service" onchange="this.form.submit()">
        <option value="" <%= 'selected' if @service.nil? || @service.empty? %>>All</option>
        <% @services.each do |service_key| %>
          <option value="<%= service_key %>" <%= 'selected' if @service == service_key %>>
            <%= service_key.capitalize %>
          </option>
        <% end %>
      </select>
    </div>

    <div class="filter-group">
      <button type="submit" class="btn btn-secondary btn-small">Apply Filters</button>
      <a href="/coar/dashboard" class="btn btn-secondary btn-small">Clear</a>
    </div>
  </form>
</div>

<div class="stats-section">
  <p class="stats-text">
    Showing <%= @notifications.length %> of <%= @total_count %> notifications
  </p>
</div>

<% if @notifications.empty? %>
  <div class="empty-state">
    <p>No notifications found.</p>
    <p><a href="/coar/dashboard/send" class="btn btn-primary">Send a notification</a></p>
  </div>
<% else %>
  <div class="table-container">
    <table class="notifications-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Direction</th>
          <th>Type</th>
          <th>Service</th>
          <th>Status</th>
          <th>Issue</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @notifications.each do |notification| %>
          <tr class="notification-row <%= notification.direction %> <%= notification.status %>">
            <td>
              <code class="notification-id"><%= notification.id %></code>
            </td>
            <td>
              <span class="badge badge-<%= notification.direction %>">
                <%= notification.direction == 'sent' ? 'üì§' : 'üì•' %>
                <%= notification.direction.upcase %>
              </span>
            </td>
            <td class="type-cell">
              <span class="type-primary"><%= notification.primary_type %></span>
            </td>
            <td>
              <%= notification.service_name || '-' %>
            </td>
            <td>
              <span class="status-badge status-<%= notification.status %>">
                <%= notification.status %>
              </span>
            </td>
            <td>
              <% if notification.issue_id %>
                <a href="https://github.com/<%= ENV['REVIEWS_REPOSITORY'] || 'neurolibre/neurolibre-reviews' %>/issues/<%= notification.issue_id %>" target="_blank" class="issue-link">
                  #<%= notification.issue_id %>
                </a>
              <% else %>
                -
              <% end %>
            </td>
            <td class="date-cell">
              <%= notification.created_at.strftime('%Y-%m-%d %H:%M') %>
            </td>
            <td>
              <a href="/coar/dashboard/notifications/<%= notification.id %>" class="btn btn-small btn-link">
                View
              </a>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <% if @total_count > @limit %>
    <div class="pagination">
      <% if @offset > 0 %>
        <a href="?offset=<%= [@offset - @limit, 0].max %>&limit=<%= @limit %>&direction=<%= @direction %>&status=<%= @status %>&service=<%= @service %>" class="btn btn-secondary btn-small">
          ‚Üê Previous
        </a>
      <% end %>

      <span class="pagination-info">
        Page <%= (@offset / @limit) + 1 %> of <%= (@total_count.to_f / @limit).ceil %>
      </span>

      <% if @offset + @limit < @total_count %>
        <a href="?offset=<%= @offset + @limit %>&limit=<%= @limit %>&direction=<%= @direction %>&status=<%= @status %>&service=<%= @service %>" class="btn btn-secondary btn-small">
          Next ‚Üí
        </a>
      <% end %>
    </div>
  <% end %>
<% end %>
